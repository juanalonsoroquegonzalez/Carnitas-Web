---
// Plato.astro
// Props opcionales para inicializar con productos
interface Product {
  id: number;
  name: string;
  price: number;
  quantity: number;
  type?: string;
}

const { products = [] } = Astro.props as { products?: Product[] };
---
<div class="plato-container w-full max-w-xs sm:max-w-sm md:max-w-md p-3 sm:p-4 bg-gray-50 rounded-xl shadow-md mx-auto flex flex-col h-[400px] sm:h-[400px]">
  <!-- Encabezado fijo -->
  <h2 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4 sm:text-xs flex-shrink-0">Mi Plato</h2>

  <!-- Lista scrollable -->
  <div id="plate-items" class="flex-1 overflow-y-auto space-y-2">
    {products.length === 0 ? (
      <p class="text-gray-500 text-sm sm:text-xs">Agrega aqui productos que quieras que vayan en un mismo plato.</p>
    ) : (
      products.map(product => (
        <div
          id={`plate-item-${product.id}`}
          class="flex justify-between items-center bg-white p-2 sm:p-3 rounded-lg shadow-sm text-xs sm:text-2xs"
        >
          <div>
            <p class="font-semibold">{product.name} {product.type ? `- ${product.type}` : ''}</p>
            <p class="text-gray-500 text-xs sm:text-2xs">Cantidad: {product.quantity}</p>
          </div>
          <div class="flex items-center gap-2">
            <button
              class="text-red-500 hover:text-red-700 text-xs sm:text-2xs"
              onclick={`removeFromPlate(${product.id})`}
            >
               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7L5 7M6 7l1 12a2 2 0 002 2h6a2 2 0 002-2l1-12M10 11v6M14 11v6M9 7V5a2 2 0 012-2h2a2 2 0 012 2v2"/>
                </svg>
            </button>
          </div>
        </div>
      ))
    )}
  </div>

  <!-- Total fijo -->
  <div class="mt-3 sm:mt-4 text-right font-bold text-sm sm:text-sm flex-shrink-0" id="plate-total">
    Total: ${products.reduce((sum, p) => sum + p.price * p.quantity, 0)}
  </div>

  <!-- BotÃ³n fijo -->
  <button
    id="add-plate-to-cart"
    class="mt-3 sm:mt-4 w-full sm:w-3/4 btn-primary block mx-auto md:text-xs sm:text-xs flex-shrink-0"
    onclick="addPlateToCart()"
  >
    Add Carrito
  </button>
</div>


<script>

import { getSupabaseClient } from '../lib/supabaseClient';

const supabase = getSupabaseClient();
window.addEventListener('DOMContentLoaded', () => {
  const savedPhone = localStorage.getItem('userPhone');
  if (savedPhone) {
    window.userPhone = savedPhone;
  }
});
let plate: PlateProduct[] = [];

window.loadPlate = async function(userPhone: string) {
  plate = [];

  const { data: platos, error: platosError } = await supabase
    .from('plato')
    .select('id')
    .eq('telefono_cliente', userPhone)
    .eq('status', 'activo')
    .order('fecha', { ascending: false });

  if (platosError) {
    console.error('Error al obtener plato:', platosError);
    return;
  }

  if (!platos || platos.length === 0) {
    window.renderPlate();
    return;
  }

  const platoId = platos[0].id;

    const { data: detalles, error: detallesError } = await supabase
    .from('plato_detalle')
    .select(`
      id,
      cantidad,
      precio_unitario,
      tipo,
      modo,
      producto:id_producto (
        nombre,
        imagen
      )
    `)
    .eq('id_plato', platoId);
    

  if (detallesError) {
    console.error('Error al obtener detalles del plato:', detallesError);
    return;
  }

  if (!detalles || detalles.length === 0) {
    window.renderPlate();
    return;
  }
 
  detalles.forEach((d: any) => {
    plate.push({
      id: d.id,
      name: d.producto.nombre,
      type: d.tipo,
      price: d.precio_unitario,
      quantity: d.cantidad
    });
  });

  window.renderPlate();
}

window.renderPlate = async function() {
  const container = document.getElementById('plate-items')!;
  const totalDiv = document.getElementById('plate-total')!;

  container.innerHTML = '';

  if (plate.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-sm sm:text-xs">Agrega aqui productos que quieras que vayan en un mismo plato.</p>';
    totalDiv.textContent = 'Total: $0';
    return;
  }

  plate.forEach(p => {
    const div = document.createElement('div');
    div.id = `plate-item-${p.id}`;
    div.className = 'flex justify-between items-center bg-white p-3 rounded-lg shadow-sm';

    div.innerHTML = `
      <div>
        <p class="font-semibold text-xs">${p.name}${p.type ? ` - ${p.type}` : ''}</p>
        <p class="text-gray-500 text-xs">Cantidad: ${p.quantity}</p>
      </div>
      <div class="flex items-center gap-2">
        <button class="text-red-500 hover:text-red-700 text-xs sm:text-2xs" onclick="removeFromPlate(${p.id})">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7L5 7M6 7l1 12a2 2 0 002 2h6a2 2 0 002-2l1-12M10 11v6M14 11v6M9 7V5a2 2 0 012-2h2a2 2 0 012 2v2"/>
          </svg>
        </button>
      </div>
    `;
    container.appendChild(div);
  });

  // Calcular total del plato
  const total = plate.reduce((sum, p) => sum + p.price * p.quantity, 0);
  totalDiv.textContent = `Total: $${total}`;
}
interface PlateProduct {
  id: number;
  name: string;
  price: number;
  quantity: number;
  type?: string;
}
declare global {
  interface Window {
    renderPlate: () => Promise<void>;
    loadPlate: (userPhone: string) => Promise<void>;
    removeFromPlate: (detalleId: number) => Promise<void>;
  }
  
}

window.removeFromPlate = async function(detalleId: number) {
  try {
    if (!window.userPhone) return;

    const { data: platos } = await supabase
      .from('plato')
      .select('id')
      .eq('telefono_cliente', window.userPhone)
      .eq('status', 'activo')
      .order('fecha', { ascending: false });

    if (!platos || platos.length === 0) return;

    const platoId = platos[0].id;

    await supabase
      .from('plato_detalle')
      .delete()
      .eq('id', detalleId)
      .eq('id_plato', platoId);

    plate = plate.filter(p => p.id !== detalleId);
    window.renderPlate();
  } catch (err) {
    console.error('Error eliminando producto del plato:', err);
  }
};


</script>