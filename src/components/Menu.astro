<section class="bg-gray-100 py-12">
  <div class="max-w-6xl mx-auto px-6">
    <h2 class="text-3xl font-bold text-center mb-10">Nuestro Menú de Carnitas</h2>

    <div class="grid md:grid-cols-3 gap-8">
      <!-- Tarjeta 1 -->
       <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:scale-105 transition-transform duration-300 flex flex-col">
          <img src="/receta.jpg" alt="Torta de carnitas" class="w-full h-64 object-cover">
          <div class="p-6 flex flex-col flex-1">
            <h3 class="text-xl font-semibold mb-2">Carnitas</h3>
            <p class="text-gray-700 mb-4 flex-1">
              Deliciosas carnitas y cueritos acompañadas de salsa de jitomate cruda y doraditas.
            </p>
            <div class="mb-4">
            <p class="text-sm font-medium text-gray-700 mb-2">
              Elige tu tipo:
            </p>

            <div class="flex gap-3">
              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="tipo-1"
                  value="Carnitas"
                  class="hidden peer"
                  checked
                />
                <span
                  class="px-3 py-1 rounded-full text-sm
                        border border-gray-300
                        peer-checked:bg-gradient-to-r
                        peer-checked:from-yellow-500 peer-checked:to-orange-500
                        peer-checked:text-white
                        peer-checked:border-transparent
                        transition-all duration-200"
                >
                  Carnitas
                </span>
              </label>

              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="tipo-1"
                  value="Cueritos"
                  class="hidden peer"
                />
                <span
                  class="px-3 py-1 rounded-full text-sm
                        border border-gray-300
                        peer-checked:bg-gradient-to-r
                        peer-checked:from-yellow-500 peer-checked:to-orange-500
                        peer-checked:text-white
                        peer-checked:border-transparent
                        transition-all duration-200"
                >
                  Cueritos
                </span>
              </label>

              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="tipo-1"
                  value="Surtido"
                  class="hidden peer"
                />
                <span
                  class="px-3 py-1 rounded-full text-sm
                        border border-gray-300
                        peer-checked:bg-gradient-to-r
                        peer-checked:from-yellow-500 peer-checked:to-orange-500
                        peer-checked:text-white
                        peer-checked:border-transparent
                        transition-all duration-200"
                >
                  Surtido
                </span>
              </label>
            </div>
          </div>
            <span class="text-lg font-bold text-yellow-700 mb-4">$340 MXN / Kg</span>

           <!-- Modo de compra -->
<div class="mb-3">
  <p class="text-sm font-medium text-gray-700 mb-2">
    Forma de compra:
  </p>

  <div class="flex gap-3">
    <label class="cursor-pointer">
      <input type="radio" name="modo-1" value="gramos" class="hidden peer" checked>
      <span
        class="px-3 py-1 rounded-full text-sm border border-gray-300
               peer-checked:bg-gradient-to-r
               peer-checked:from-yellow-500 peer-checked:to-orange-500
               peer-checked:text-white
               peer-checked:border-transparent
               transition">
        Por gramos
      </span>
    </label>

    <label class="cursor-pointer">
      <input type="radio" name="modo-1" value="pesos" class="hidden peer">
      <span
        class="px-3 py-1 rounded-full text-sm border border-gray-300
               peer-checked:bg-gradient-to-r
               peer-checked:from-yellow-500 peer-checked:to-orange-500
               peer-checked:text-white
               peer-checked:border-transparent
               transition">
        Por pesos
      </span>
    </label>
  </div>
</div>
<div class="mt-auto">
  <div class="flex items-center gap-2 mb-2">
    <button
      class="bg-gray-200 px-3 py-1 rounded-l hover:bg-gray-300 transition"
      onclick="updateQty(this, -1, this)">
      -
    </button>

    <input
      type="tel"
      value="100 g"
      class="qty-input w-20 text-center border-t border-b border-gray-200"
      onblur="handleQtyBlur(this)"
    >

    <button
      class="bg-gray-200 px-3 py-1 rounded-r hover:bg-gray-300 transition"
      onclick="updateQty(this, 1, this)">
      +
    </button>
  </div>

  <button
    class="add-cart-btn btn-primary w-full"
    data-id="1"
    data-name="Carnitas"
    data-price-kg="340"
  >
    Agregar al carrito
  </button>
</div>
          </div>
        </div>

        <!-- Tarjeta 2 -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:scale-105 transition-transform duration-300 flex flex-col">
          <img src="/torta.jpg" alt="Torta de carnitas" class="w-full h-64 object-cover">
          <div class="p-6 flex flex-col flex-1">
            <h3 class="text-xl font-semibold mb-2">Torta de Carnitas</h3>
            <p class="text-gray-700 mb-4 flex-1">
              Bolillo salado para torta con carnitas, salsa de jitomate, cebolla curtida, salsa brava y doraditas.
            </p>
            <div class="mb-4">
  <p class="text-sm font-medium text-gray-700 mb-2">
    Elige tu tipo:
  </p>

  <div class="flex gap-3">
    <label class="flex items-center gap-2 cursor-pointer">
      <input
        type="radio"
        name="tipo-2"
        value="Carnitas"
        class="hidden peer"
        checked
      />
      <span
        class="px-3 py-1 rounded-full text-sm
               border border-gray-300
               peer-checked:bg-gradient-to-r
               peer-checked:from-yellow-500 peer-checked:to-orange-500
               peer-checked:text-white
               peer-checked:border-transparent
               transition-all duration-200"
      >
        Carnitas
      </span>
    </label>

    <label class="flex items-center gap-2 cursor-pointer">
      <input
        type="radio"
        name="tipo-2"
        value="Cueritos"
        class="hidden peer"
      />
      <span
        class="px-3 py-1 rounded-full text-sm
               border border-gray-300
               peer-checked:bg-gradient-to-r
               peer-checked:from-yellow-500 peer-checked:to-orange-500
               peer-checked:text-white
               peer-checked:border-transparent
               transition-all duration-200"
      >
        Cueritos
      </span>
    </label>

    <label class="flex items-center gap-2 cursor-pointer">
      <input
        type="radio"
        name="tipo-2"
        value="Surtido"
        class="hidden peer"
      />
      <span
        class="px-3 py-1 rounded-full text-sm
               border border-gray-300
               peer-checked:bg-gradient-to-r
               peer-checked:from-yellow-500 peer-checked:to-orange-500
               peer-checked:text-white
               peer-checked:border-transparent
               transition-all duration-200"
      >
        Surtido
      </span>
    </label>
  </div>
</div>
            <span class="text-lg font-bold text-yellow-700 mb-4">$55 MXN</span>

            <div class="mt-auto">
              <div class="flex items-center gap-2 mb-2">
                <button class="bg-gray-200 px-3 py-1 rounded-l hover:bg-gray-300 transition-colors" onclick="updateQty(this, -1)">-</button> 
                <input type="text" value="0" class="qty-input w-12 text-center border-t border-b border-gray-200" readonly> 
                <button class="bg-gray-200 px-3 py-1 rounded-r hover:bg-gray-300 transition-colors" onclick="updateQty(this, 1)">+</button>
              </div>

              <button 
                class="add-cart-btn btn-primary w-full"
                data-id="2"
                data-name="Torta de Carnitas"
                data-price="55">
                Agregar al carrito
              </button>
            </div>
          </div>
        </div>

        <!-- Tarjeta 3 -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:scale-105 transition-transform duration-300 flex flex-col">
          <img src="/Carnitas.jpg" alt="Tacos de carnitas" class="w-full h-64 object-cover">
          <div class="p-6 flex flex-col flex-1">
            <h3 class="text-xl font-semibold mb-2">Tacos de Carnitas</h3>
            <p class="text-gray-700 mb-4 flex-1">
              Tortilla de maiz de tamaño normal con carnitas con cebolla, cilantro, repollo, salsa de jitomate cruda, salsa picante de tomate y guacamole.
            </p>
            <div class="mb-4">
  <p class="text-sm font-medium text-gray-700 mb-2">
    Elige tu tipo:
  </p>

  <div class="flex gap-3">
    <label class="flex items-center gap-2 cursor-pointer">
      <input
        type="radio"
        name="tipo-3"
        value="Carnitas"
        class="hidden peer"
        checked
      />
      <span
        class="px-3 py-1 rounded-full text-sm
               border border-gray-300
               peer-checked:bg-gradient-to-r
               peer-checked:from-yellow-500 peer-checked:to-orange-500
               peer-checked:text-white
               peer-checked:border-transparent
               transition-all duration-200"
      >
        Carnitas
      </span>
    </label>

    <label class="flex items-center gap-2 cursor-pointer">
      <input
        type="radio"
        name="tipo-3"
        value="Cueritos"
        class="hidden peer"
      />
      <span
        class="px-3 py-1 rounded-full text-sm
               border border-gray-300
               peer-checked:bg-gradient-to-r
               peer-checked:from-yellow-500 peer-checked:to-orange-500
               peer-checked:text-white
               peer-checked:border-transparent
               transition-all duration-200"
      >
        Cueritos
      </span>
    </label>

    <label class="flex items-center gap-2 cursor-pointer">
      <input
        type="radio"
        name="tipo-3"
        value="Surtido"
        class="hidden peer"
      />
      <span
        class="px-3 py-1 rounded-full text-sm
               border border-gray-300
               peer-checked:bg-gradient-to-r
               peer-checked:from-yellow-500 peer-checked:to-orange-500
               peer-checked:text-white
               peer-checked:border-transparent
               transition-all duration-200"
      >
        Surtido
      </span>
    </label>
  </div>
</div>
            <span class="text-lg font-bold text-yellow-700 mb-4">$25 MXN</span>

            <div class="mt-auto">
              <div class="flex items-center gap-2 mb-2">
                <button class="bg-gray-200 px-3 py-1 rounded-l hover:bg-gray-300 transition-colors" onclick="updateQty(this, -1)">-</button> 
                <input type="text" value="0" class="qty-input w-12 text-center border-t border-b border-gray-200" readonly> 
                <button class="bg-gray-200 px-3 py-1 rounded-r hover:bg-gray-300 transition-colors" onclick="updateQty(this, 1)">+</button>
              </div>

              <button 
                class="add-cart-btn btn-primary w-full"
                data-id="3"
                data-name="Tacos de Carnitas"
                data-price="25">
                Agregar al carrito
              </button>
            </div>
          </div>
        </div>

        <!-- Tarjeta 4 -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:scale-105 transition-transform duration-300 flex flex-col">
          <img src="/botanero.jpg" alt="Tacos Dorados" class="w-full h-64 object-cover">
          <div class="p-6 flex flex-col flex-1">
            <h3 class="text-xl font-semibold mb-2">Tacos Dorados</h3>
            <p class="text-gray-700 mb-4 flex-1">
              Tortilla de maiz de tamaño normal con carnitas con cebolla, salsa de jitomate, cilantro, repollo, salsa de jitomate cruda, salsa picante de tomate y guacamole.
            </p>
            <div class="mb-4">
            <p class="text-sm font-medium text-gray-700 mb-2">
              Elige tu tipo:
            </p>

            <div class="flex gap-3">
              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="tipo-4"
                  value="Papa"
                  class="hidden peer"
                  checked
                />
                <span
                  class="px-3 py-1 rounded-full text-sm
                        border border-gray-300
                        peer-checked:bg-gradient-to-r
                        peer-checked:from-yellow-500 peer-checked:to-orange-500
                        peer-checked:text-white
                        peer-checked:border-transparent
                        transition-all duration-200"
                >
                  Papa
                </span>
              </label>
            </div>
          </div>
            <span class="text-lg font-bold text-yellow-700 mb-4">$9 MXN</span>

            <div class="mt-auto">
              <div class="flex items-center gap-2 mb-2">
                <button class="bg-gray-200 px-3 py-1 rounded-l hover:bg-gray-300 transition-colors" onclick="updateQty(this, -1)">-</button> 
                <input type="text" value="0" class="qty-input w-12 text-center border-t border-b border-gray-200" readonly> 
                <button class="bg-gray-200 px-3 py-1 rounded-r hover:bg-gray-300 transition-colors" onclick="updateQty(this, 1)">+</button>
              </div>

              <button 
                class="add-cart-btn btn-primary w-full"
                data-id="4"
                data-name="Tacos Dorados"
                data-price="9">
                Agregar al carrito
              </button>
            </div>
          </div>
        </div>

        <!-- Tarjeta 5 -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:scale-105 transition-transform duration-300 flex flex-col">
          <img src="/dael.jpg" alt="Tacos Dorados con Carnitas" class="w-full h-64 object-cover">
          <div class="p-6 flex flex-col flex-1">
            <h3 class="text-xl font-semibold mb-2">Tacos Dorados con Carnitas</h3>
            <p class="text-gray-700 mb-4 flex-1">
              Tortilla de maiz de tamaño normal con carnitas con cebolla, salsa de jitomate, cilantro, repollo, salsa de jitomate cruda, salsa picante de tomate y guacamole.
            </p>
            <div class="mb-4">
  <p class="text-sm font-medium text-gray-700 mb-2">
    Elige tu tipo:
  </p>

  <div class="flex gap-3">
    <label class="flex items-center gap-2 cursor-pointer">
      <input
        type="radio"
        name="tipo-5"
        value="Carnitas"
        class="hidden peer"
        checked
      />
      <span
        class="px-3 py-1 rounded-full text-sm
               border border-gray-300
               peer-checked:bg-gradient-to-r
               peer-checked:from-yellow-500 peer-checked:to-orange-500
               peer-checked:text-white
               peer-checked:border-transparent
               transition-all duration-200"
      >
        Carnitas
      </span>
    </label>

    <label class="flex items-center gap-2 cursor-pointer">
      <input
        type="radio"
        name="tipo-5"
        value="Cueritos"
        class="hidden peer"
      />
      <span
        class="px-3 py-1 rounded-full text-sm
               border border-gray-300
               peer-checked:bg-gradient-to-r
               peer-checked:from-yellow-500 peer-checked:to-orange-500
               peer-checked:text-white
               peer-checked:border-transparent
               transition-all duration-200"
      >
        Cueritos
      </span>
    </label>

    <label class="flex items-center gap-2 cursor-pointer">
      <input
        type="radio"
        name="tipo-5"
        value="Surtido"
        class="hidden peer"
      />
      <span
        class="px-3 py-1 rounded-full text-sm
               border border-gray-300
               peer-checked:bg-gradient-to-r
               peer-checked:from-yellow-500 peer-checked:to-orange-500
               peer-checked:text-white
               peer-checked:border-transparent
               transition-all duration-200"
      >
        Surtido
      </span>
    </label>
  </div>
</div>
            <span class="text-lg font-bold text-yellow-700 mb-4">$22 MXN</span>

            <div class="mt-auto">
              <div class="flex items-center gap-2 mb-2">
                <button class="bg-gray-200 px-3 py-1 rounded-l hover:bg-gray-300 transition-colors" onclick="updateQty(this, -1)">-</button> 
                <input type="text" value="0" class="qty-input w-12 text-center border-t border-b border-gray-200" readonly> 
                <button class="bg-gray-200 px-3 py-1 rounded-r hover:bg-gray-300 transition-colors" onclick="updateQty(this, 1)">+</button>
              </div>

              <button 
                class="add-cart-btn btn-primary w-full"
                data-id="5"
                data-name="Tacos Dorados con Carnitas"
                data-price="22">
                Agregar al carrito
              </button>
            </div>
          </div>
        </div>

    </div>
  </div>
</section>

<script>
import { getSupabaseClient } from '../lib/supabaseClient';

const supabase = getSupabaseClient();
declare global {
  interface Window {
    userPhone?: string;
    pendingProduct?: Product;
  }
}
type Product = {
  id: number;
  name: string;
  price: number;
  qty: number;
  modo?: string;
  unidad?: string;
};

const cart: Product[] = [];
(window as any).cart = cart;
(window as any).pendingProduct = null;

const savedPhone = localStorage.getItem('userPhone');
if (savedPhone) {
  window.userPhone = savedPhone;
}
(window as any).updateQty = function (
  button: HTMLButtonElement,
  delta: number
) {
  // Encontrar el input dentro del mismo contenedor
  const container = button.closest('.mt-auto');
  if (!container) return;
  
  const input = container.querySelector('input.qty-input') as HTMLInputElement;
  if (!input) return;

  let numericValue = parseInt(input.value.replace(/[^\d]/g, ''), 10) || 0;
  numericValue += delta;
  if (numericValue < 0) numericValue = 0;
  
  const card = button.closest('.bg-white.rounded-2xl');
  if (!card) return;

  const modoInput = card.querySelector('input[name="modo-1"]:checked') as HTMLInputElement | null;
  const modo = modoInput?.value;
  if (modo) {
    
    if (modo === 'gramos') {
      if (numericValue < 100) numericValue = 100;
      input.value = `${numericValue} g`;
    } else if (modo === 'pesos') {
      if (numericValue < 50) numericValue = 50;
      input.value = `$${numericValue}`;
    }
  } else {
    if (numericValue < 1) numericValue = 1;
    input.value = numericValue.toString();
  }

  input.dataset.value = numericValue.toString();
};
// Función para actualizar el input cuando cambia el radio button
function actualizarInputPorModo(radio: HTMLInputElement) {
  // Encontrar la card contenedora
  const card = radio.closest('.bg-white.rounded-2xl');
  if (!card) return;
  
  // Encontrar el input de cantidad dentro de la misma card
  const input = card.querySelector('input.qty-input') as HTMLInputElement;
  if (!input) return;

  const modo = radio.value;
  let numericValue = parseInt(input.value.replace(/[^\d]/g, ''), 10);

    numericValue = modo === 'gramos' ? 100 : 50;

  // Aplicar mínimo según modo
  if (modo === 'gramos') {
    if (numericValue < 100) numericValue = 100;
    input.value = `${numericValue} g`;
  } else if (modo === 'pesos') {
    if (numericValue < 50) numericValue = 50;
    input.value = `$${numericValue}`;
  }

  input.dataset.value = numericValue.toString();
}

// Agregar event listeners a todos los radios modo-1
document.addEventListener('DOMContentLoaded', function() {
  const radios = document.querySelectorAll('input[name="modo-1"]');
  radios.forEach(radio => {
    radio.addEventListener('change', function(this: HTMLInputElement) {
      actualizarInputPorModo(this);
    });
  });
});

// También actualizar si se crean nuevas cards dinámicamente
const observer = new MutationObserver(function(mutations) {
  mutations.forEach(mutation => {
    mutation.addedNodes.forEach(node => {
      if (node.nodeType === 1) { // Element node
        const radios = (node as Element).querySelectorAll('input[name="modo-1"]');
        radios.forEach(radio => {
          radio.addEventListener('change', function(this: HTMLInputElement) {
            actualizarInputPorModo(this);
          });
        });
      }
    });
  });
});

observer.observe(document.body, { childList: true, subtree: true });
// Función para cuando se sale del input
(window as any).handleQtyBlur = function (input: HTMLInputElement) {
  const card = input.closest('.bg-white.rounded-2xl');
  if (!card) return;

  const modoInput = card.querySelector('input[name="modo-1"]:checked') as HTMLInputElement | null;
  const modo = modoInput?.value;

  let numericValue = parseInt(input.value.replace(/[^\d]/g, ''), 10);

  if (modo === 'gramos') {
    if (isNaN(numericValue) || numericValue < 100) numericValue = 100;
    input.value = `${numericValue} g`;
  } else if (modo === 'pesos') {
    if (isNaN(numericValue) || numericValue < 50) numericValue = 50;
    input.value = `$${numericValue}`;
  } else {
    if (isNaN(numericValue) || numericValue < 1) numericValue = 1;
    input.value = numericValue.toString();
  }

  input.dataset.value = numericValue.toString();
};
// Función para agregar al carrito y guardar en Supabase
async function addToCartAndDB(product: Product) {
  if (product.qty <= 0) {
    alert('Selecciona al menos 1 unidad');
    return;
  }

  // Actualizar carrito local
  const existing = cart.find(item => item.id === product.id);
  if (existing) existing.qty += product.qty;
  else cart.push({ ...product });

  try {
    // Buscar pedido activo
    let { data: pedido, error } = await supabase
      .from('pedidos')
      .select('numero_pedido')
      .eq('telefono_cliente', window.userPhone)
      .eq('status', 'activo')
      .maybeSingle();

    let pedidoId: number;
    if (pedido) {
      pedidoId = pedido.numero_pedido;
    } else {
      // Crear nuevo pedido
      if (!window.userPhone) throw new Error('Phone number is required');
      const newPedido = await crearPedido(window.userPhone);
      pedidoId = newPedido.numero_pedido;
    }
    
    const card = document.querySelector(`[data-id="${product.id}"]`)?.closest('.bg-white');
    const tipo = card?.querySelector('input[type="radio"]:checked')?.getAttribute('value');

    // Insertar detalle de pedido
    const { data: detalle, error: errDetalle } = await supabase
      .from('pedido_detalle')
      .insert({
        telefono_cliente: window.userPhone,
        id_pedido: pedidoId,
        producto: product.id,
        precio_unitario: product.price,
        cantidad: product.qty,
        modo: product.modo || '',
        unidad: product.unidad || '',
        tipo: tipo || 'Desconocido'
      });

    if (errDetalle) throw errDetalle;

  } catch (err) {
    console.error('Error al guardar en la base de datos:', err);
  }
}
async function crearPedido(telefono: string) {
      const numeroPedido = await getNextNumeroPedido(telefono);

      const { data, error } = await supabase
        .from('pedidos')
        .insert({
          telefono_cliente: telefono,
          numero_pedido: numeroPedido,
          total: 0,
          status: 'activo'
        })
        .select('id, numero_pedido')
        .single();

      if (error) throw error;
      return data;
    }

    async function getNextNumeroPedido(telefono: string) {
      const { data, error } = await supabase
        .from('pedidos')
        .select('numero_pedido')
        .eq('telefono_cliente', telefono)
        .order('numero_pedido', { ascending: false })
        .maybeSingle();

      if (error && error.code !== 'PGRST116') {
        throw error;
      }

      return data ? data.numero_pedido + 1 : 1;
    }

document.querySelectorAll('.add-cart-btn').forEach((btn) => {
  const button = btn as HTMLButtonElement;
  button.addEventListener('click', () => {
    // Obtener la card contenedora
    const card = button.closest('.bg-white.rounded-2xl');
    if (!card) return;
    
    // Detectar si es producto de carnitas (tiene radios modo-1)
    const modoInput = card.querySelector('input[name="modo-1"]:checked') as HTMLInputElement | null;
    const modo = modoInput?.value;
    
    // Obtener el input de cantidad
    const input = card.querySelector('input.qty-input') as HTMLInputElement;
    if (!input) return;
    
    // Extraer valor numérico
    let qty = parseInt(input.value.replace(/[^\d]/g, ''), 10) || 0;
    
    // PRECIO BASE
    let precioBase = parseFloat(button.dataset.priceKg || button.dataset.price || "0");
    let precioFinal = precioBase;
    let cantidadFinal = qty;

    // AJUSTE PARA CARNITAS
    if (modo) {
      if (modo === 'gramos') {
        // Asegurar mínimo 100 gramos
        if (qty < 100) qty = 100;
        
        // Calcular precio: (gramos / 1000) * precio por kg
        precioFinal = (qty / 1000) * precioBase;
        cantidadFinal = qty; // Guardamos los gramos
        
      } else if (modo === 'pesos') {
        // Asegurar mínimo $50
        if (qty < 50) qty = 50;
        
        // Calcular gramos: (pesos / precio por kg) * 1000
        const gramos = Math.round((qty / precioBase) * 1000);
        precioFinal = qty; // El precio es lo que el usuario pagará
        cantidadFinal = gramos; // Guardamos los gramos calculados
      }
    } else {
      // Producto normal (sin modo)
      if (qty < 1) qty = 1;
      cantidadFinal = qty;
      precioFinal = precioBase * qty;
    }

    // Validar teléfono
    const savedPhone = localStorage.getItem('userPhone');
    if (savedPhone) {
      window.userPhone = savedPhone;
    }

    if (!window.userPhone) {
      alert('Ingresa con tu número de teléfono');
      return;
    }

    // Crear objeto producto
    const product: Product = {
      id: parseInt(button.dataset.id!),
      name: button.dataset.name!,
      price: parseFloat(precioFinal.toFixed(2)), // Redondear a 2 decimales
      qty: cantidadFinal,
      modo: modo, // Guardar el modo para referencia
      unidad: modo === 'gramos' ? 'g' : (modo === 'pesos' ? 'g' : 'pza')
    };

    // Agregar al carrito
    addToCartAndDB(product);
    
    // Resetear input
    if (modo === 'gramos') {
      input.value = '100 g';
      input.dataset.value = '100';
    } else if (modo === 'pesos') {
      input.value = '$50';
      input.dataset.value = '50';
    } else {
      input.value = '1';
      input.dataset.value = '1';
    }
  });
});
</script>
