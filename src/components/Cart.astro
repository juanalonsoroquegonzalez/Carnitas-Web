<div id="phone-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-xl p-6 w-80 shadow-lg">
    <h3 class="text-lg font-semibold mb-4">Ingresa tu n√∫mero de tel√©fono</h3>
    <input type="text" id="phone-input-modal" placeholder="55 1234 5678" class="w-full border px-3 py-2 rounded mb-4">
    <div class="flex justify-end gap-2">
      <button id="phone-cancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 transition">Cancelar</button>
      <button id="phone-submit" class="px-4 py-2 rounded bg-yellow-600 text-white hover:bg-yellow-500 transition">Guardar</button>
    </div>
  </div>
</div>

<!-- Carrito flotante -->
<button
  id="order-toggle"
  class="fixed bottom-6 right-6 z-50
         px-5 py-3 rounded-full
         bg-gradient-to-r from-yellow-500 to-orange-500
         text-white font-medium
         shadow-lg
         hover:from-yellow-600 hover:to-orange-600
         hover:shadow-xl
         transition-all duration-300
         active:scale-95"
>
  üõí Hacer Pedido
</button>

<!-- Panel de pedidos -->
<div
  id="order-panel"
  class="fixed inset-0 bg-black/40 backdrop-blur-sm flex justify-center items-center hidden z-50"
>
  <div
    class="bg-white/80 w-11/12 max-w-4xl p-4 md:p-6 rounded-2xl shadow-xl relative
           flex flex-col md:flex-row gap-4 md:gap-6
           max-h-[90vh] overflow-hidden"
  >
    <button
      id="close-panel"
      class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 font-bold text-lg"
    >
      &times;
    </button>

    <!-- üü° Pedidos activos -->
    <div class="w-full md:w-120 flex flex-col max-h-62 md:max-h-[600px]">

      <!-- Header fijo -->
      <div id="pedido-general" class="pb-2">
        <h3 class="text-lg font-semibold">Sin Pedidos</h3>
      </div>

      <!-- Scroll SOLO aqu√≠ -->
      <div
        id="active-orders"
        class="flex-1 overflow-y-auto space-y-2 py-2 border rounded-lg p-4"
      ></div>

      <!-- Footer fijo -->
      <div
        id="total-general"
        class="text-right font-bold text-lg pt-2"
      >
        Total: $0.00
      </div>
    </div>

    <!-- üü¢ Info cliente -->
    <div class="w-full flex-1 flex flex-col gap-3 overflow-y-auto">
      <h2 class="text-2xl font-bold mb-2">Especificaciones del Pedido</h2>

      <input
        type="text"
        id="name"
        placeholder="Nombre"
        class="w-full px-3 py-2 border rounded"
      />

      <input
        type="tel"
        id="phone-order"
        placeholder="Tel√©fono"
        class="w-full px-3 py-2 border rounded"
      />

      <div class="flex flex-col md:flex-row gap-2">
        <input
          type="text"
          id="address"
          placeholder="Domicilio"
          class="flex-1 px-3 py-2 border rounded"
        />
        <button
          id="get-location"
          class="bg-gray-200 px-3 py-2 rounded hover:bg-gray-300 text-sm"
        >
          Compartir ubicaci√≥n
        </button>
      </div>

      <textarea
        id="comments"
        placeholder="Comentarios del pedido"
        class="w-full px-3 py-2 border rounded"
      ></textarea>

      <button
        id="place-order"
        class="w-full bg-yellow-600 text-white py-3 rounded-lg hover:bg-yellow-500 transition-colors"
      >
        Confirmar Pedido
      </button>
    </div>
  </div>
</div>

</div>

<script>
import { getSupabaseClient } from '../lib/supabaseClient';

const supabase = getSupabaseClient();
// --- Variables globales ---
let userPhone = '';
const phoneToggleBtn = document.getElementById('phone-toggle');
const phoneModal = document.getElementById('phone-modal');
const phoneInputModal = document.getElementById('phone-input-modal');
const phoneCancel = document.getElementById('phone-cancel');
const phoneSubmit = document.getElementById('phone-submit');
const orderToggle = document.getElementById('order-toggle');
const orderPanel = document.getElementById('order-panel');
const closePanel = document.getElementById('close-panel');
const activeOrdersContainer = document.getElementById('active-orders');

declare global {
  interface Window {
    loadActiveOrders: (phone: string) => Promise<void>;
  }
}

window.loadActiveOrders = async function(phone: string) {
  const container = document.getElementById('active-orders');
  const totalDiv = document.getElementById('total-general');
  const pedidoDiv = document.getElementById('pedido-general');
  if(!container || !totalDiv) return;

  container.innerHTML = '<p class="text-gray-500 text-sm">Cargando pedidos...</p>';
  totalDiv.innerHTML = '';
  if (pedidoDiv) pedidoDiv.innerHTML = '';

  const { data: pedidos, error } = await supabase
    .from('pedidos')
    .select(`
      fecha,
      status,
      numero_pedido,
      pedido_detalle(
        id,
        cantidad,
        precio_unitario,
        tipo,
        unidad,
        modo,
        producto(
          nombre,
          imagen
        )
      )
    `)
    .eq('telefono_cliente', phone)
    .eq('status', 'activo')
    // Ordenar pedidos del m√°s reciente al m√°s antiguo
    .order('fecha', { ascending: false })
    // Ordenar detalles por ID descendente
    .order('id', { 
      foreignTable: 'pedido_detalle', 
      ascending: false 
    });

  if(error) {
    container.innerHTML = '<p class="text-red-500">Error cargando pedidos.</p>';
    console.error(error);
    return;
  }

  if(!pedidos || pedidos.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-sm">No hay pedidos activos.</p>';
    totalDiv.innerHTML = 'Total Pedido: $0';
    if (pedidoDiv) pedidoDiv.innerHTML = 'Sin pedidos';
    return;
  }

  container.innerHTML = '';
  let totalPedidos = 0;
  let pedido = 0;
  let fecha = '';

  pedidos.forEach(pedido => {
    let totalPedido = 0;

    const detalleHTML = pedido.pedido_detalle.map((item: any) => {
      let subtotal = item.cantidad * item.precio_unitario;
      let unit;
      let sub
      if(item.modo === 'gramos'){
        sub = item.precio_unitario;
        unit = '340';
        totalPedido += sub;
      }
      else if(item.modo === 'pesos'){
        unit = '340';
        sub = item.precio_unitario;
        totalPedido += sub;
      }
      else{
        sub = subtotal;
        unit = item.precio_unitario;
        totalPedido += sub;
      }
      return `
       <div
          id="detalle-${item.id}"
          data-subtotal="${subtotal}"
          class="flex items-center gap-3 py-2 transition-all duration-200 ease-in-out"
        >
          <img src="${item.producto.imagen || '/placeholder.png'}"
              class="w-16 h-16 object-cover rounded-lg">

          <div class="flex-1">
            <div class="font-semibold">${item.producto.nombre}</div>
            <div class="text-sm text-gray-700">${item.tipo}</div>
            <div class="text-sm text-gray-500">Cantidad: ${item.cantidad}${item.unidad ? ` ${item.unidad}` : ''}</div>
          </div>

          <div class="text-right flex flex-col items-end gap-1">
            <div class="font-semibold">$${unit}</div>
            <div class="text-gray-500 text-sm">Subtotal: $${sub}</div>

            <button
              class="text-red-500 text-xs hover:underline"
              onclick="deleteDetalle(${item.id}, ${pedido.numero_pedido})"
            >
              Eliminar
            </button>
          </div>
        </div>

      `;
    }).join('');

    totalPedidos += totalPedido;

    const div = document.createElement('div');
    div.className = 'rounded-xl p-4 shadow-lg mb-2 relative';
    div.innerHTML = `
      <div class="mb-2 flex items-center">
      </div>
      <div class="divide-y divide-gray-200">
        ${detalleHTML}
      </div>
    `;
    container.appendChild(div);
    totalDiv.innerHTML = `<span class="font-bold text-lg">Total Pedido: $${totalPedidos}</span>`;
    if (pedidoDiv) pedidoDiv.innerHTML = `<strong>Pedido #${pedido.numero_pedido}</strong> - ${new Date(pedido.fecha).toLocaleString()}`;
  });
}
function actualizarTotalPedido(numeroPedido: number, subtotalRestar: number) {
  const totalEl = document.getElementById(`total-pedido-${numeroPedido}`);
  if (!totalEl) return;

  const totalActual = Number(totalEl.innerText) || 0;
  const nuevoTotal = Math.max(totalActual - subtotalRestar, 0);

  totalEl.innerText = nuevoTotal.toFixed(2);
}

// --- Funci√≥n para actualizar bot√≥n toggle ---
function updatePhoneToggle() {
  const savedPhone = localStorage.getItem('userPhone');

  if(savedPhone) {
    userPhone = savedPhone;
    if(phoneToggleBtn) phoneToggleBtn.textContent = 'Salir';
    // Cargar pedidos autom√°ticamente
    window.loadActiveOrders(userPhone);
  } else {
    userPhone = '';
    if(phoneToggleBtn) phoneToggleBtn.textContent = 'Ingresar tel√©fono';
    if(activeOrdersContainer) activeOrdersContainer.innerHTML = '<p class="text-gray-500 text-sm">No hay pedidos activos.</p>';
  }
}

// --- Al cargar p√°gina ---
window.addEventListener('DOMContentLoaded', updatePhoneToggle);

// --- Click toggle ---
phoneToggleBtn?.addEventListener('click', () => {
  if(userPhone) {
    // Salir
    localStorage.removeItem('userPhone');
    updatePhoneToggle();
  } else {
    // Abrir modal
    phoneModal?.classList.remove('hidden');
  }
});

// --- Modal cancelar ---
phoneCancel?.addEventListener('click', () => {
  phoneModal?.classList.add('hidden');
});

// --- Guardar tel√©fono desde modal ---
phoneSubmit?.addEventListener('click', () => {
  const phone = (phoneInputModal as HTMLInputElement).value.trim();
  if(!phone) { alert("Ingresa un n√∫mero de tel√©fono v√°lido."); return; }
  localStorage.setItem('userPhone', phone);
  updatePhoneToggle();
  phoneModal?.classList.add('hidden');
});

// --- Abrir panel de pedidos ---
orderToggle?.addEventListener('click', () => {
  if(!userPhone) { alert("Por favor ingresa tu tel√©fono primero."); return; }
  orderPanel?.classList.remove('hidden');
  window.loadActiveOrders(userPhone);
});

// --- Cerrar panel ---
closePanel?.addEventListener('click', () => orderPanel?.classList.add('hidden'));

// --- Geolocalizaci√≥n ---
const getLocationBtn = document.getElementById('get-location');
const addressInput = document.getElementById('address');
if(getLocationBtn && addressInput) {
  getLocationBtn.addEventListener('click', () => {
    if(navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        (addressInput as HTMLInputElement).value = `Lat: ${latitude.toFixed(5)}, Lon: ${longitude.toFixed(5)}`;
      }, () => alert('No se pudo obtener la ubicaci√≥n. Ingresa manualmente.'));
    } else alert('Geolocalizaci√≥n no soportada.');
  });
}

// --- Confirmar pedido ---
const placeOrderBtn = document.getElementById('place-order');
placeOrderBtn?.addEventListener('click', async () => {
  const name = (document.getElementById('name') as HTMLInputElement).value.trim();
  const phone = (document.getElementById('phone-order') as HTMLInputElement).value.trim();
  const address = (document.getElementById('address') as HTMLInputElement).value.trim();
  const comments = (document.getElementById('comments') as HTMLTextAreaElement).value.trim();
  const totalText = document.getElementById('total-general')?.textContent || '0';

  // Quitar todo excepto n√∫meros y punto
  const total = Number(
    totalText.replace(/[^0-9.]/g, '')
  );

  if(!userPhone) { alert("No hay tel√©fono definido."); return; }

  try {
    // Actualizar pedido activo m√°s reciente con info del cliente y cerrar
    const { data, error } = await supabase
      .from('pedidos')
      .update({
        nombre_cliente: name || null,
        celular: phone || null,
        ubicacion: address || null,
        comentarios: comments || null,
        total : total || null,
        status: 'pendiente',
      })
      .eq('telefono_cliente', userPhone)
      .eq('status', 'activo');

    if(error) throw error;

    // Limpiar campos y cerrar panel
    (document.getElementById('name') as HTMLInputElement).value = '';
    (document.getElementById('phone-order') as HTMLInputElement).value = '';
    (document.getElementById('address') as HTMLInputElement).value = '';
    (document.getElementById('comments') as HTMLTextAreaElement).value = '';
    orderPanel?.classList.add('hidden');

    // Recargar pedidos
    window.loadActiveOrders(userPhone);

    alert("Pedido confirmado y cerrado exitosamente!");
  } catch(err) {
    console.error(err);
    alert("Error al confirmar pedido.");
  }
});
async function deletePedido(pedidoId: number) {
  const { data: detalles, error: errorDetalles } = await supabase
    .from('pedido_detalle')
    .delete()
    .eq('id_pedido', pedidoId);

  if (errorDetalles) {
    console.error('Error al eliminar detalles:', errorDetalles);
    return;
  }

  const { data, error } = await supabase
    .from('pedidos')
    .delete()
    .eq('numero_pedido', pedidoId);

  if (error) {
    console.error('Error al eliminar pedido:', error);
  } else {
    window.loadActiveOrders(userPhone); // refresca la lista
  }
}
async function deleteDetalle(detalleId: number, numeroPedido: number) {
  const detalleEl = document.getElementById(`detalle-${detalleId}`);
  if (!detalleEl) return;

  const subtotal = Number(detalleEl.dataset.subtotal) || 0;

  const { error } = await supabase
    .from('pedido_detalle')
    .delete()
    .eq('id', detalleId);

  if (error) {
    console.error('Error al eliminar detalle:', error);
    return;
  }

  const { data: restantes, error: checkError } = await supabase
    .from('pedido_detalle')
    .select('id')
    .eq('id_pedido', numeroPedido)
    .limit(1);

  if (checkError) {
    console.error('Error al verificar detalles:', checkError);
    return;
  }

  if (!restantes || restantes.length === 0) {
    await supabase
      .from('pedidos')
      .delete()
      .eq('numero_pedido', numeroPedido)
      .eq('telefono_cliente', userPhone);
  }

  window.loadActiveOrders(userPhone);
}

// @ts-ignore
window.deletePedido = deletePedido;
// @ts-ignore
window.deleteDetalle = deleteDetalle;

</script>
